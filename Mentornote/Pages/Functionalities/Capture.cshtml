@page
@model Mentornote.Pages.Functionalities.CaptureModel
@{
    Layout = null;
}
<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    <link rel="stylesheet" href="~/css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bruno+Ace&family=Michroma&family=Smooch+Sans:wght@100..900&display=swap" rel="stylesheet">
</head>
<body class="func-nav-body">
    <nav class="func-navigation" id="func-navigation">
        <a href="~/Start" class="brand">
            <img src="https://img.icons8.com/ios-filled/50/FFFFFF/graduation-cap.png" alt="Logo" class="logo" />
            <div class="brand-text">
                <h1>MentorNote</h1>
                <p>AI Study Assistant</p>
            </div>
        </a>

        <div class="nav-section">
            <p class="nav-section-title">STUDY TOOLS</p>
            <ul class="nav-links">
                <a href="~/Functionalities/SpeechCapture" class="nav-item">
                    Back
                </a>
                <li id="capture-summary" class="nav-item active">
                    Summary
                </li>
                <li id="capture-chat" class="nav-item">
                    Chat
                </li>
            </ul>
        </div>  
    </nav>

    <div class="f-home-controller">
        <div class="header">
            <div>
                <section>
                    <h1>Dashboard</h1>
                </section>

                <button id="menu-btn" class="menu-btn">☰</button>
            </div>
        </div>
        <div class="capture-summary" id="summarybox">
            <p>@Html.Raw(Model.Summary)</p>
        </div>
        <div class="capture-chat hidden" id="chatbox">
         
            <div id="chat-window" class="chat-window">
                <div class="message-row bot">
                    <div class="bot-icon">
                        🎓
                    </div>
                    <div class="message-bubble">
                        Hi! I'm ready to answer questions about "<strong>@Model.ActiveCapture.Title</strong>". What would you like to know?
                    </div>
                </div>

                <!-- Chat History -->
                @if (Model.ChatMessages != null && Model.ChatMessages.Any())
                {
                    foreach (var msg in Model.ChatMessages)
                    {
                        <div class="chat-message user-msg">
                            <p>@msg.Message</p>
                            <span class="timestamp">@msg.CreatedAt.ToString("HH:mm")</span>
                        </div>
                        <div class="chat-message ai-msg">
                            <p>@msg.Response</p>
                            <span class="timestamp">@msg.CreatedAt.ToString("HH:mm")</span>
                        </div>
                    }
                }
                else
                {
                    <p class="no-messages">No messages yet. Start the conversation below!</p>
                }
            </div>
            <form id="chat-form" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="SpeechCaptureId" value="@Model.ActiveCapture.Id" />
                <div class="chat-input-container">
                    <input type="text" id="userMessage" name="UserMessage" placeholder="Type your message..." required />
                    <input type="hidden" id="activeSection" name="activeSection" value="summary" />
                    <input type="submit" Name="Submit" value="Go" class="send-btn"/>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const menuBtn = document.getElementById('menu-btn');
        const sideNav = document.getElementById('func-navigation');

        menuBtn.addEventListener('click', () => {
          sideNav.classList.toggle('active');
        });

        // Optional: close nav when clicking outside it
        document.addEventListener('click', (e) => {
          if (!sideNav.contains(e.target) && !menuBtn.contains(e.target)) {
            sideNav.classList.remove('active');

          }
        });

        //Switch Pages
        const capturechatbutton = document.getElementById("capture-chat");
        const capturesummarybutton = document.getElementById("capture-summary");
        const summarybox = document.getElementById("summarybox");
        const chatbox = document.getElementById("chatbox");

        capturechatbutton.addEventListener('click', () =>{
            summarybox.classList.add('hidden');
            chatbox.classList.remove('hidden');
            capturechatbutton.classList.add('active')
            capturesummarybutton.classList.remove('active')

    
            document.getElementById("activeSection").value = "chat";
        })

        capturesummarybutton.addEventListener('click', () =>{
            summarybox.classList.remove('hidden');
            chatbox.classList.add('hidden');
            capturechatbutton.classList.remove('active')
            capturesummarybutton.classList.add('active')

            document.getElementById("activeSection").value = "summary";
        })


        // Set initial active section based on server-side value

            document.addEventListener("DOMContentLoaded", function () {
            const activeSection = "@ViewData["ActiveSection"]";
            if (activeSection === "chat") {
                summarybox.classList.add('hidden');
                chatbox.classList.remove('hidden');
                capturechatbutton.classList.add('active');
                capturesummarybutton.classList.remove('active');
            } else {
                summarybox.classList.remove('hidden');
                chatbox.classList.add('hidden');
                capturechatbutton.classList.remove('active');
                capturesummarybutton.classList.add('active');
            }
        });

    </script>
</body>
</html>